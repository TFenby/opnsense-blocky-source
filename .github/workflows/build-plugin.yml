name: Build Plugin

on:
  push:
    tags:
      - "plugin-v*"
  workflow_dispatch:
    inputs:
      blocky_version:
        description: "Blocky version tag (e.g. v0.28.2)"
        required: false

env:
  PKG_ABI: "FreeBSD:14:amd64"
  REPO_REPO: opnsense-blocky

jobs:
  build-and-publish:
    runs-on: ubuntu-latest
    concurrency:
      group: build-plugin
      cancel-in-progress: true
    permissions:
      contents: write
      id-token: write
      attestations: write
    steps:
      - name: Checkout source
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Resolve blocky version
        id: resolve
        run: |
          TAG="${{ github.event.inputs.blocky_version }}"
          if [ -z "$TAG" ]; then
            TAG="$(cat BLOCKY_VERSION | tr -d '[:space:]')"
            echo "No version input provided — using BLOCKY_VERSION: $TAG"
          fi
          echo "tag=$TAG" >> "$GITHUB_OUTPUT"

      - name: Validate tag format
        run: |
          TAG="${{ steps.resolve.outputs.tag }}"
          echo "$TAG" | grep -qE '^v[0-9]+\.[0-9]+\.[0-9]+$' || { echo "::error::Invalid tag format '$TAG'. Expected vX.Y.Z"; exit 1; }

      - name: Check PKG_REPO_KEY secret
        run: |
          if [ -z "${{ secrets.PKG_REPO_KEY }}" ]; then
            echo "::error::PKG_REPO_KEY secret not configured — see supply chain security prerequisites"
            exit 1
          fi

      - name: Parse version
        id: version
        run: |
          TAG="${{ steps.resolve.outputs.tag }}"
          SHORT="${TAG#v}"
          MAJOR_MINOR=$(echo "$SHORT" | cut -d. -f1,2)
          PATCH=$(echo "$SHORT" | cut -d. -f3)
          echo "tag=$TAG" >> "$GITHUB_OUTPUT"
          echo "short=$SHORT" >> "$GITHUB_OUTPUT"
          echo "major_minor=$MAJOR_MINOR" >> "$GITHUB_OUTPUT"
          echo "patch=${PATCH:-0}" >> "$GITHUB_OUTPUT"

      - name: Parse plugin version
        id: plugin
        run: |
          VER=$(grep '^PLUGIN_VERSION=' dns/blocky-tfenby/Makefile | sed 's/.*=[[:space:]]*//')
          REV=$(grep '^PLUGIN_REVISION=' dns/blocky-tfenby/Makefile | sed 's/.*=[[:space:]]*//' || true)
          if [ -n "$REV" ] && [ "$REV" != "0" ]; then
            echo "version=${VER}_${REV}" >> "$GITHUB_OUTPUT"
          else
            echo "version=${VER}" >> "$GITHUB_OUTPUT"
          fi

      - name: Download and verify blocky FreeBSD binary
        run: |
          TAG="${{ steps.version.outputs.tag }}"
          ASSET="blocky_${TAG}_Freebsd_x86_64.tar.gz"
          URL="https://github.com/0xERR0R/blocky/releases/download/${TAG}/${ASSET}"

          echo "Downloading $URL"
          curl -fSL "$URL" -o "$ASSET"
          curl -fSL "https://github.com/0xERR0R/blocky/releases/download/${TAG}/blocky_checksums.txt" -o checksums.txt

          echo "Verifying SHA256 checksum"  # Yes I know. TODO: check if hosted elsewhere
          grep "$ASSET" checksums.txt | sha256sum -c -

          mkdir -p staging/bin
          tar xzf "$ASSET" -C staging/bin
          chmod +x staging/bin/blocky
          file staging/bin/blocky

      - name: Write signing key
        run: |
          echo "${{ secrets.PKG_REPO_KEY }}" | base64 -d > repo.key
          chmod 0400 repo.key

      - name: Build packages in FreeBSD
        uses: vmactions/freebsd-vm@v1
        with:
          release: "14.2"
          usesh: true
          copyback: true
          mem: 6144
          prepare: pkg install -y git
          run: |
            set -eu

            VERSION="${{ steps.version.outputs.major_minor }}"
            REVISION="${{ steps.version.outputs.patch }}"

            echo "==> Building binary package: blocky-tfenby ${VERSION}_${REVISION}"
            sh Scripts/build-blocky-pkg.sh "${VERSION}" "${REVISION}" staging/bin/blocky

            echo "==> Installing binary package (needed for plugin PLUGIN_DEPENDS)"
            pkg add dist/FreeBSD:14:amd64/blocky-tfenby-*.pkg

            echo "==> Building plugin package"
            PLUGIN_HASH=$(echo "${{ github.sha }}" | cut -c1-9)
            cd dns/blocky-tfenby
            make package PLUGIN_PHP=84 PLUGIN_PYTHON=311 PLUGIN_HASH="${PLUGIN_HASH}"
            cd ../..

            echo "==> Copying plugin package to dist"
            cp dns/blocky-tfenby/work/pkg/*.pkg dist/FreeBSD:14:amd64/

            echo "==> Generating repo index"
            pkg repo dist/FreeBSD:14:amd64/ repo.key

            echo "==> Verifying repo catalog is signed"
            ls -la dist/FreeBSD:14:amd64/packagesite.pkg

            echo "==> Packages built:"
            ls -la dist/FreeBSD:14:amd64/

      - name: Clean signing key
        if: always()
        run: rm -f repo.key

      - name: Publish to pkg repo
        run: |
          ABI="${{ env.PKG_ABI }}"

          git clone "https://x-access-token:${{ secrets.PKG_REPO_TOKEN }}@github.com/${{ github.repository_owner }}/${{ env.REPO_REPO }}.git" pkg-repo

          mkdir -p "pkg-repo/${ABI}"

          # Clean old package versions before copying new ones.
          # FreeBSD/OPNsense repos only serve the latest version per package.
          rm -f "pkg-repo/${ABI}"/blocky-tfenby-*.pkg
          rm -f "pkg-repo/${ABI}"/os-blocky-tfenby-*.pkg

          rm -f "pkg-repo/${ABI}"/{meta*,packagesite*,data*}

          cp dist/"${ABI}"/*.pkg "pkg-repo/${ABI}/"
          cp dist/"${ABI}"/meta.conf "pkg-repo/${ABI}/" 2>/dev/null || true
          cp dist/"${ABI}"/meta "pkg-repo/${ABI}/" 2>/dev/null || true
          cp dist/"${ABI}"/packagesite.pkg "pkg-repo/${ABI}/" 2>/dev/null || true

          cd pkg-repo

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add -A
          git diff --cached --quiet && echo "No changes to pkg repo" && exit 0
          git commit -m "Update packages: plugin ${{ steps.plugin.outputs.version }}, blocky ${{ steps.version.outputs.tag }}"
          git push

      - name: Update BLOCKY_VERSION
        if: ${{ !startsWith(github.ref, 'refs/tags/') }}
        run: |
          echo "${{ steps.version.outputs.tag }}" > BLOCKY_VERSION
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add BLOCKY_VERSION
          git diff --cached --quiet && echo "No changes to BLOCKY_VERSION" && exit 0
          git commit -m "Bump BLOCKY_VERSION to ${{ steps.version.outputs.tag }}"
          git push

      - name: Create GitHub release
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          TAG="blocky-${{ steps.version.outputs.tag }}-plugin-v${{ steps.plugin.outputs.version }}"

          # Create release if it doesn't exist, then upload/overwrite assets.
          # Tolerates CI re-runs for the same plugin version.
          gh release create "$TAG" \
            --title "Plugin ${{ steps.plugin.outputs.version }} — Blocky ${{ steps.version.outputs.tag }}" \
            --notes "Built OPNsense packages: plugin ${{ steps.plugin.outputs.version }}, blocky ${{ steps.version.outputs.tag }}" \
            --latest 2>/dev/null || true

          gh release upload "$TAG" \
            dist/${{ env.PKG_ABI }}/*.pkg \
            --clobber

      - name: Attest build provenance
        uses: actions/attest-build-provenance@v3
        with:
          subject-path: 'dist/${{ env.PKG_ABI }}/*.pkg'
