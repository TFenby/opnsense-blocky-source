name: Build Plugin

on:
  workflow_dispatch:
    inputs:
      blocky_version:
        description: "Blocky version tag (e.g. v0.28.2)"
        required: true

env:
  PLUGIN_ABI: "FreeBSD:14:amd64"
  REPO_REPO: opnsense-blocky

jobs:
  build-and-publish:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout source
        uses: actions/checkout@v4

      - name: Parse version
        id: version
        run: |
          TAG="${{ github.event.inputs.blocky_version }}"
          SHORT="${TAG#v}"
          MAJOR_MINOR=$(echo "$SHORT" | cut -d. -f1,2)
          PATCH=$(echo "$SHORT" | cut -d. -f3)
          echo "tag=$TAG" >> "$GITHUB_OUTPUT"
          echo "short=$SHORT" >> "$GITHUB_OUTPUT"
          echo "major_minor=$MAJOR_MINOR" >> "$GITHUB_OUTPUT"
          echo "patch=${PATCH:-0}" >> "$GITHUB_OUTPUT"

      - name: Download blocky FreeBSD binary
        run: |
          TAG="${{ steps.version.outputs.tag }}"
          ASSET="blocky_${TAG}_Freebsd_x86_64.tar.gz"
          URL="https://github.com/0xERR0R/blocky/releases/download/${TAG}/${ASSET}"
          echo "Downloading $URL"
          curl -fSL "$URL" -o blocky.tar.gz
          mkdir -p staging/bin
          tar xzf blocky.tar.gz -C staging/bin
          chmod +x staging/bin/blocky
          file staging/bin/blocky

      - name: Build packages in FreeBSD
        uses: vmactions/freebsd-vm@v1
        with:
          release: "14.2"
          usesh: true
          copyback: true
          mem: 6144
          prepare: pkg install -y git
          run: |
            set -eu

            VERSION="${{ steps.version.outputs.major_minor }}"
            REVISION="${{ steps.version.outputs.patch }}"

            echo "==> Building binary package: blocky ${VERSION}_${REVISION}"
            sh Scripts/build-blocky-pkg.sh "${VERSION}" "${REVISION}" staging/bin/blocky

            echo "==> Installing binary package (needed for plugin PLUGIN_DEPENDS)"
            pkg add dist/FreeBSD:14:amd64/blocky-*.pkg

            echo "==> Building plugin package"
            cd dns/blocky-tfen
            make package PLUGIN_PHP=84 PLUGIN_PYTHON=311
            cd ../..

            echo "==> Copying plugin package to dist"
            cp dns/blocky-tfen/work/pkg/*.pkg dist/FreeBSD:14:amd64/

            echo "==> Generating repo index"
            pkg repo dist/FreeBSD:14:amd64/

            echo "==> Packages built:"
            ls -la dist/FreeBSD:14:amd64/

      - name: Publish to pkg repo
        run: |
          ABI="${{ env.PLUGIN_ABI }}"

          git clone "https://x-access-token:${{ secrets.PKG_REPO_TOKEN }}@github.com/${{ github.repository_owner }}/${{ env.REPO_REPO }}.git" pkg-repo

          mkdir -p "pkg-repo/${ABI}"

          cp dist/"${ABI}"/*.pkg "pkg-repo/${ABI}/"
          cp dist/"${ABI}"/meta.conf "pkg-repo/${ABI}/" 2>/dev/null || true
          cp dist/"${ABI}"/meta "pkg-repo/${ABI}/" 2>/dev/null || true
          cp dist/"${ABI}"/packagesite.pkg "pkg-repo/${ABI}/" 2>/dev/null || true

          cd pkg-repo

          # Ensure symlinks for pkg compatibility
          if [ -f "${ABI}/packagesite.pkg" ]; then
            rm -f "${ABI}/packagesite.tzst"
            ln -sf packagesite.pkg "${ABI}/packagesite.tzst"
          fi
          if [ -f "${ABI}/data.pkg" ]; then
            rm -f "${ABI}/data.tzst"
            ln -sf data.pkg "${ABI}/data.tzst"
          fi

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add -A
          git diff --cached --quiet && echo "No changes to pkg repo" && exit 0
          git commit -m "Update blocky packages to ${{ steps.version.outputs.tag }}"
          git push

      - name: Update BLOCKY_VERSION
        run: |
          echo "${{ steps.version.outputs.tag }}" > BLOCKY_VERSION
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add BLOCKY_VERSION
          git diff --cached --quiet && echo "No changes to BLOCKY_VERSION" && exit 0
          git commit -m "Bump BLOCKY_VERSION to ${{ steps.version.outputs.tag }}"
          git push

      - name: Create GitHub release
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          TAG="blocky-${{ steps.version.outputs.tag }}"
          gh release create "$TAG" \
            --title "Blocky ${{ steps.version.outputs.tag }}" \
            --notes "Built OPNsense packages for Blocky ${{ steps.version.outputs.tag }}" \
            --latest \
            dist/${{ env.PLUGIN_ABI }}/*.pkg
